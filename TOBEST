-- Mini Hub | Ninja Style
if getgenv().MiniHubLoaded then return end
getgenv().MiniHubLoaded = true

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LP = Players.LocalPlayer

-- States
local LightOn, ESPOn, Open = false, false, true
local ESPTags = {}

-- GUI
local Gui = Instance.new("ScreenGui", game:GetService("CoreGui"))
Gui.Name = "MiniHub"
Gui.ResetOnSpawn = false

-- ===== Button Creator =====
local function createButton(txt, w)
	local b = Instance.new("TextButton", Gui)
	b.Size = UDim2.new(0, w or 90, 0, 28)
	b.Text = txt
	b.BackgroundColor3 = Color3.fromRGB(25,25,25)
	b.TextColor3 = Color3.new(1,1,1)
	b.TextSize = 13
	b.Font = Enum.Font.SourceSansBold
	b.AutoButtonColor = false
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,7)
	local s = Instance.new("UIStroke", b)
	s.Thickness = 1.4
	return b, s
end

-- Buttons
local FoldBtn, FoldStroke = createButton("_", 30)
local LightBtn, LightStroke = createButton("LIGHT")
local ESPBtn, ESPStroke = createButton("ESP")
local DelBtn, DelStroke = createButton("-", 30)

-- Position
FoldBtn.Position = UDim2.new(0,8,0.42,0)
LightBtn.Position = FoldBtn.Position + UDim2.new(0,34,0,0)
ESPBtn.Position   = LightBtn.Position + UDim2.new(0,94,0,0)
DelBtn.Position   = ESPBtn.Position + UDim2.new(0,94,0,0)

local Buttons = {FoldBtn, LightBtn, ESPBtn, DelBtn}

-- ===== Drag =====
local drag, startInput, startPos
FoldBtn.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		drag = true
		startInput = i.Position
		startPos = {}
		for _,b in ipairs(Buttons) do startPos[b] = b.Position end
	end
end)

UserInputService.InputChanged:Connect(function(i)
	if drag and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
		local d = i.Position - startInput
		for b,p in pairs(startPos) do
			b.Position = UDim2.new(p.X.Scale,p.X.Offset+d.X,p.Y.Scale,p.Y.Offset+d.Y)
		end
	end
end)

UserInputService.InputEnded:Connect(function() drag = false end)

-- ===== Fold =====
FoldBtn.MouseButton1Click:Connect(function()
	Open = not Open
	LightBtn.Visible = Open
	ESPBtn.Visible = Open
	DelBtn.Visible = Open
	FoldBtn.Text = Open and "_" or "+"
end)

-- ===== Delete =====
DelBtn.MouseButton1Click:Connect(function()
	for _,v in pairs(ESPTags) do
		if v.bg then v.bg:Destroy() end
	end
	Gui:Destroy()
	getgenv().MiniHubLoaded = nil
end)

-- ===== Light =====
local function setupLight(char)
	local hrp = char:WaitForChild("HumanoidRootPart",5)
	if not hrp then return end
	local l = Instance.new("PointLight", hrp)
	l.Name = "PlayerLight"
	l.Brightness = 2
	l.Range = 90
	l.Enabled = LightOn
end

if LP.Character then setupLight(LP.Character) end
LP.CharacterAdded:Connect(setupLight)

LightBtn.MouseButton1Click:Connect(function()
	LightOn = not LightOn
	local hrp = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
	if hrp and hrp:FindFirstChild("PlayerLight") then
		hrp.PlayerLight.Enabled = LightOn
	end
	LightBtn.Text = LightOn and "LIGHT ON" or "LIGHT"
end)

-- ===== ESP =====
local function setupESP(plr)
	if plr == LP then return end
	local function onChar(char)
		local head = char:WaitForChild("Head",5)
		if not head then return end

		local bg = Instance.new("BillboardGui", head)
		bg.Size = UDim2.new(0,120,0,28)
		bg.AlwaysOnTop = true

		local txt = Instance.new("TextLabel", bg)
		txt.Size = UDim2.new(1,0,1,0)
		txt.BackgroundTransparency = 1
		txt.TextColor3 = Color3.new(1,1,1)
		txt.TextStrokeTransparency = 0
		txt.TextSize = 13

		ESPTags[plr] = {bg=bg, text=txt, head=head}
	end
	plr.CharacterAdded:Connect(onChar)
	if plr.Character then onChar(plr.Character) end
end

for _,p in ipairs(Players:GetPlayers()) do setupESP(p) end
Players.PlayerAdded:Connect(setupESP)

ESPBtn.MouseButton1Click:Connect(function()
	ESPOn = not ESPOn
	ESPBtn.Text = ESPOn and "ESP ON" or "ESP"
end)

-- ===== Loop =====
local hue = 0
RunService.RenderStepped:Connect(function(dt)
	hue = (hue + dt*0.4) % 1
	local col = Color3.fromHSV(hue,1,1)

	FoldStroke.Color = col
	LightStroke.Color = col
	ESPStroke.Color = col
	DelStroke.Color = col

	if not ESPOn then
		for _,v in pairs(ESPTags) do v.bg.Enabled = false end
		return
	end

	local lh = LP.Character and LP.Character:FindFirstChild("Head")
	if not lh then return end

	for plr,v in pairs(ESPTags) do
		if v.head and v.head.Parent then
			v.bg.Enabled = true
			local d = math.floor((v.head.Position - lh.Position).Magnitude)
			v.text.Text = plr.Name.." ["..d.."m]"
		end
	end
end)
