-- ===============================
-- Ninja Hub | One Line Load
-- ===============================
if getgenv().NINJA_HUB then return end
getgenv().NINJA_HUB = true

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local LP = Players.LocalPlayer

-- State
local LightOn, ESPOn, Fold = false, false, false
local ESPTags = {}

-- GUI
local Gui = Instance.new("ScreenGui")
Gui.Name = "NinjaHub"
Gui.ResetOnSpawn = false
Gui.Parent = game:GetService("CoreGui")

-- ===== Button Creator =====
local function mkBtn(txt)
	local b = Instance.new("TextButton", Gui)
	b.Size = UDim2.new(0,90,0,26)
	b.Text = txt
	b.BackgroundColor3 = Color3.fromRGB(25,25,25)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.SourceSansBold
	b.TextSize = 12
	b.AutoButtonColor = false

	Instance.new("UICorner", b).CornerRadius = UDim.new(0,6)
	local s = Instance.new("UIStroke", b)
	s.Thickness = 1.5
	return b, s
end

-- Buttons
local BtnLight, S1 = mkBtn("LIGHT")
local BtnESP,   S2 = mkBtn("ESP")
local BtnFold,  S3 = mkBtn("_")
local BtnDel,   S4 = mkBtn("-")

-- Position (ติดกัน)
BtnLight.Position = UDim2.new(0,8,0.4,0)
BtnESP.Position   = BtnLight.Position + UDim2.new(0,0,0,30)
BtnFold.Position  = BtnESP.Position + UDim2.new(0,0,0,30)
BtnDel.Position   = BtnFold.Position + UDim2.new(0,0,0,30)

-- ===== Drag Group =====
local drag, startPos, startBtns
local btns = {BtnLight, BtnESP, BtnFold, BtnDel}

local function bindDrag(btn)
	btn.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
			drag = true
			startPos = i.Position
			startBtns = {}
			for _,b in pairs(btns) do
				startBtns[b] = b.Position
			end
		end
	end)
end

for _,b in pairs(btns) do bindDrag(b) end

UIS.InputChanged:Connect(function(i)
	if drag and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
		local d = i.Position - startPos
		for b,p in pairs(startBtns) do
			b.Position = UDim2.new(p.X.Scale,p.X.Offset+d.X,p.Y.Scale,p.Y.Offset+d.Y)
		end
	end
end)

UIS.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		drag = false
	end
end)

-- ===== Light =====
local function setupLight(c)
	local hrp = c:WaitForChild("HumanoidRootPart",5)
	if not hrp then return end
	local l = Instance.new("PointLight", hrp)
	l.Name = "NinjaLight"
	l.Range = 22
	l.Brightness = 2
	l.Enabled = LightOn
end

if LP.Character then setupLight(LP.Character) end
LP.CharacterAdded:Connect(setupLight)

BtnLight.MouseButton1Click:Connect(function()
	LightOn = not LightOn
	local c = LP.Character
	if c and c:FindFirstChild("HumanoidRootPart") then
		local l = c.HumanoidRootPart:FindFirstChild("NinjaLight")
		if l then l.Enabled = LightOn end
	end
	BtnLight.Text = LightOn and "LIGHT ON" or "LIGHT"
end)

-- ===== ESP =====
local function addESP(p)
	if p == LP then return end
	local function char(c)
		local h = c:WaitForChild("Head",5)
		if not h then return end

		local bg = Instance.new("BillboardGui", h)
		bg.Size = UDim2.new(0,100,0,24)
		bg.AlwaysOnTop = true
		bg.Enabled = false

		local t = Instance.new("TextLabel", bg)
		t.Size = UDim2.new(1,0,1,0)
		t.BackgroundTransparency = 1
		t.TextStrokeTransparency = 0
		t.Font = Enum.Font.SourceSansBold
		t.TextSize = 12

		ESPTags[p] = {bg=bg,text=t,head=h}
	end
	p.CharacterAdded:Connect(char)
	if p.Character then char(p.Character) end
end

for _,p in pairs(Players:GetPlayers()) do addESP(p) end
Players.PlayerAdded:Connect(addESP)

BtnESP.MouseButton1Click:Connect(function()
	ESPOn = not ESPOn
	BtnESP.Text = ESPOn and "ESP ON" or "ESP"
end)

-- ===== Fold / Delete =====
BtnFold.MouseButton1Click:Connect(function()
	Fold = not Fold
	BtnLight.Visible = not Fold
	BtnESP.Visible = not Fold
	BtnFold.Text = Fold and "+" or "_"
end)

BtnDel.MouseButton1Click:Connect(function()
	Gui:Destroy()
	getgenv().NINJA_HUB = false
end)

-- ===== Loop =====
local h = 0
RunService.RenderStepped:Connect(function(dt)
	h = (h + dt*0.4) % 1
	for _,s in pairs({S1,S2,S3,S4}) do
		s.Color = Color3.fromHSV(h,1,1)
	end

	if not ESPOn then
		for _,v in pairs(ESPTags) do v.bg.Enabled = false end
		return
	end

	local c = LP.Character
	local lh = c and c:FindFirstChild("Head")
	if not lh then return end

	for p,v in pairs(ESPTags) do
		if v.head and v.head.Parent then
			local d = math.floor((v.head.Position - lh.Position).Magnitude)
			local sameTeam = (p.Team == LP.Team)
			v.text.TextColor3 = sameTeam and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
			v.text.Text = p.Name.." ["..d.."m]"
			v.bg.Enabled = true
		end
	end
end)
